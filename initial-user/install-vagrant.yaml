---
# ansible-galaxy install -p ./roles robertdebock.virtualbox
# ansible-galaxy install -p ./roles darkwizard242.vagrant
# ansible-galaxy install -p ./roles install hispanico.nginx_revproxy
# ansible-playbook -i hosts.ini install-vagrant.yaml -kK -vvv
- hosts: vagranthosts
  remote_user: devops
  become: yes

  # roles: 
  # - robertdebock.virtualbox
  # - darkwizard242.vagrant

  tasks:
  # - name: Show host's ip
  #   debug:
  #     msg: "{{ ansible_ssh_host }}"

  # - name: Remove haproxy stable repository from PPA and install its signing key on Ubuntu target
  #   ansible.builtin.apt_repository:
  #     repo: ppa:vbernat/haproxy-2.4
  #     state: absent

  # - name: Add haproxy stable repository from PPA and install its signing key on Ubuntu target
  #   ansible.builtin.apt_repository:
  #     repo: ppa:vbernat/haproxy-2.6
  #     state: present

  # - name: Update apt-get repo and cache
  #   apt: update_cache=yes force_apt_get=yes cache_valid_time=3600

  # - name: Upgrade all apt packages
  #   apt: upgrade=dist force_apt_get=yes

  # INSTALL AND CONFIGURE HAPROXY
  # - name: Install nginx
  #   ansible.builtin.apt:
  #     name: nginx
  #     state: present

  # - name: Enable nginx
  #   ansible.builtin.systemd:
  #     name: nginx
  #     state: started
  #     enabled: yes

  # # INSTALL AND CONFIGURE HAPROXY
  # - name: Install haproxy
  #   ansible.builtin.apt:
  #     name: haproxy
  #     state: present

  # - name: Enable haproxy
  #   ansible.builtin.systemd:
  #     name: haproxy
  #     state: started
  #     enabled: yes
  
  # - name: Remove haproxy.cfg file
  #   file:
  #     path: /etc/haproxy/haproxy.cfg
  #     state: absent

  # - name: configure haproxy.cfg file
  #   copy:
  #     src: sub-hosts/{{ ansible_ssh_host }}/haproxy.cfg
  #     dest: /etc/haproxy/haproxy.cfg

  # - name: " haproxy service start"
  #   service:
  #     name: haproxy
  #     state: restarted

  # - name: Install vagrant
  #   ansible.builtin.apt:
  #     name: vagrant
  #     state: absent

  - name: Install virtualbox
    ansible.builtin.apt:
      name: virtualbox
      state: present

  - name: Install vagrant
    ansible.builtin.apt:
      name: vagrant
      state: present

  - name: Remove vagrant file
    file:
      path: /home/devops/vagrant-deploy/Vagrantfile
      state: absent

  - name: deploy vagrant config
    copy:
      src: sub-hosts/{{ ansible_ssh_host }}/Vagrantfile
      dest: /home/devops/vagrant-deploy/Vagrantfile
      owner: devops
      group: devops
      mode: '0755'
  
  # ISSUE: The IP address configured for the host-only network is not within the allowed range
  # SOLUTION: https://stackoverflow.com/questions/70704093/the-ip-address-configured-for-the-host-only-network-is-not-within-the-allowed-ra
  # - name: Remove vagrant file
  #   file:
  #     path: sub-hosts/networks.conf
  #     state: absent

  # - name: configure vagrant networks to comply with 192.168.1.0
  #   copy:
  #     src: sub-hosts/networks.conf
  #     dest: /etc/vbox/networks.conf
  #     owner: root
  #     group: root
  #     mode: '0644'
  
  # - name: install prerequisites
  #   apt:
  #     name: libfuse2
  #     state: present

  - name: remove previous .vagrant
    ansible.builtin.file:
      path: /home/devops/vagrant-deploy/.vagrant
      state: absent

  # - name: move to vagrant-deploy and initilize vagrant
  #   shell:
  #     cmd: vagrant init
  #     chdir: /home/devops/vagrant-deploy/

  - name: Restart network manager for virtualbox 
    shell:
      cmd: modprobe vboxnetadp
    become: yes

  - name: move to vagrant-deploy and stop vms for this host
    shell:
      cmd: vagrant halt
      chdir: /home/devops/vagrant-deploy/
    become_user: devops

  - name: move to vagrant-deploy and launch vms for this host
    shell:
      cmd: vagrant up
      chdir: /home/devops/vagrant-deploy/
    become_user: devops

  # - name: move to vagrant-deploy and launch vms for this host
  #   shell:
  #     cmd: sh /home/devops/vagrant-deploy/start_vagrant.sh
  #     become_user: devops

  # - import_tasks: ../haproxy/install_haproxy.yaml
  - import_tasks: ../nginx/install_nginx.yaml

